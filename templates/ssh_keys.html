{% extends "base.html" %}

{% block title %}SSH Keys{% endblock %}

{% block content %}
<header class="page-header">
    <h1>SSH Keys</h1>
    <p>Manage the public keys that are available during instance provisioning. Changes take effect immediately.</p>
</header>

<section>
    <h2>Registered keys</h2>
    <small>Delete keys that are no longer needed or keep them available for future deployments.</small>
    {% if customer_id.is_some() %}
    <small>Viewing keys for customer ID: <code>{{ customer_id.as_ref().unwrap() }}</code></small>
    {% endif %}
    {% if ssh_keys.len() == 0 %}
    <p>üîë No SSH keys are registered yet. Use the form below to add your first key.</p>
    {% else %}
    <div class="list-filters mb-4">
        <div class="d-flex gap-md align-center flex-wrap">
            <span class="text-muted small">Items per page:</span>
            <div class="d-flex gap-sm">
                <a href="{{ base_url }}/ssh-keys?per_page=10&page=1{% if customer_id.is_some() %}&customer_id={{ customer_id.as_ref().unwrap() }}{% endif %}" class="btn {% if per_page == 10 %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">10</a>
                <a href="{{ base_url }}/ssh-keys?per_page=20&page=1{% if customer_id.is_some() %}&customer_id={{ customer_id.as_ref().unwrap() }}{% endif %}" class="btn {% if per_page == 20 %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">20</a>
                <a href="{{ base_url }}/ssh-keys?per_page=50&page=1{% if customer_id.is_some() %}&customer_id={{ customer_id.as_ref().unwrap() }}{% endif %}" class="btn {% if per_page == 50 %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">50</a>
            </div>
        </div>
    </div>

    <div class="card-grid">
        {% for key in ssh_keys %}
        <article>
            <h3>{{ key.name }}</h3>
            <small>ID #{{ key.id }}{% if key.customer_id.is_some() %} ¬∑ Customer {{ key.customer_id.as_ref().unwrap() }}{% endif %}</small>
            {% if key.fingerprint != "" %}
            <p><strong>Fingerprint:</strong> {{ key.fingerprint }}</p>
            {% endif %}
            {% if key.public_key != "" %}
            <pre>{{ key.public_key }}</pre>
            {% endif %}
            <footer>
                <form method="post">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="ssh_key_id" value="{{ key.id }}">
                    <button type="submit" class="btn-danger">Delete</button>
                </form>
            </footer>
        </article>
        {% endfor %}
    </div>

    <div class="pagination-container mt-4">
        <div class="pagination-info">
            Showing <strong>{{ ssh_keys.len() }}</strong> of <strong>{{ total_count }}</strong> keys
        </div>
        
        <div class="pagination-controls" role="navigation" aria-label="SSH keys pagination">
            {% if current_page > 1 %}
            <a href="{{ base_url }}/ssh-keys?page={{ current_page - 1 }}&per_page={{ per_page }}{% if customer_id.is_some() %}&customer_id={{ customer_id.as_ref().unwrap() }}{% endif %}" class="pagination-btn" aria-label="Previous page">
                <span aria-hidden="true">‚Üê</span> Previous
            </a>
            {% else %}
            <span class="pagination-btn pagination-btn-disabled">
                <span aria-hidden="true">‚Üê</span> Previous
            </span>
            {% endif %}
            
            {% if total_pages > 1 %}
            <div class="pagination-numbers">
                {% for p in 1..total_pages + 1 %}
                    {% if p == current_page %}
                    <span class="pagination-number pagination-number-active">{{ p }}</span>
                    {% else %}
                    <a href="{{ base_url }}/ssh-keys?page={{ p }}&per_page={{ per_page }}{% if customer_id.is_some() %}&customer_id={{ customer_id.as_ref().unwrap() }}{% endif %}" class="pagination-number">{{ p }}</a>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            
            {% if current_page < total_pages %}
            <a href="{{ base_url }}/ssh-keys?page={{ current_page + 1 }}&per_page={{ per_page }}{% if customer_id.is_some() %}&customer_id={{ customer_id.as_ref().unwrap() }}{% endif %}" class="pagination-btn" aria-label="Next page">
                Next <span aria-hidden="true">‚Üí</span>
            </a>
            {% else %}
            <span class="pagination-btn pagination-btn-disabled">
                Next <span aria-hidden="true">‚Üí</span>
            </span>
            {% endif %}
        </div>
    </div>
    {% endif %}
</section>

<section>
    <h2>Add a new SSH key</h2>
    <small>Provide the key name and the complete public key string (usually starting with <code>ssh-</code>).</small>
    <form method="post" novalidate>
        <input type="hidden" name="action" value="create">
        <div class="fields-grid">
            <div>
                <label for="ssh_name">Name</label>
                <input type="text" id="ssh_name" name="name" value="" required>
            </div>
        </div>
        <div>
            <label for="ssh_public_key">Public key</label>
            <textarea id="ssh_public_key" name="public_key" rows="5" required></textarea>
        </div>
        <footer class="form-actions">
            <button type="submit">Add SSH key</button>
        </footer>
    </form>
</section>
{% endblock %}
