{% extends "base.html" %}

{% block title %}Admin Access{% endblock %}

{% block content %}
<header>
    <h1>Admin Access Control</h1>
    <p>Review current assignments and adjust which instances each admin can manage.</p>
</header>

{% if admins %}
<div role="list">
    {% for username, data in admins | dictsort %}
    {% set assigned_ids = data.get('assigned_instances', []) %}
    <section role="listitem">
        <h2>{{ username }}</h2>
        <p>{{ assigned_ids | length }} assigned instance{{ '' if (assigned_ids | length) == 1 else 's' }}</p>
        <form action="{{ url_for('update_access', username=username) }}" method="post">
            <fieldset>
                <legend>Select instances</legend>
                {% if instance_map %}
                <div role="list">
                    {% for instance_id, instance in instance_map | dictsort %}
                    {% set instance_data = instance %}
                    {% set is_assigned = instance_id in assigned_ids %}
                    <label role="listitem" {% if is_assigned %}aria-current="true"{% endif %}>
                        <input type="checkbox" name="instances" value="{{ instance_id }}" {% if is_assigned %}checked{% endif %}>
                        <span>{{ instance_data.get('hostname', 'Unnamed Instance') }}</span>
                        <span>ID: {{ instance_id }}</span>
                        {% if instance_data.get('plan') %}
                        <span>Plan: {{ instance_data.get('plan', {}).get('name', 'N/A') }}</span>
                        {% endif %}
                        {% if instance_data.get('status') %}
                        <span>Status: {{ instance_data.get('status') }}</span>
                        {% endif %}
                    </label>
                    {% endfor %}
                </div>
                {% else %}
                <p>No instances available from the developer API.</p>
                {% endif %}
            </fieldset>
            <footer>
                <button type="submit">Save assignments</button>
            </footer>
        </form>
    </section>
    {% endfor %}
</div>
{% else %}
<section>
    <p>No admin users found. Create an admin account first.</p>
</section>
{% endif %}
{% endblock %}
