{% extends "base.html" %}

{% block title %}Create Instance{% endblock %}

{% block content %}
<header class="page-header">
    <div>
        <h1>Provision New Instance</h1>
        <p>Select a predefined product or craft a custom configuration.</p>
    </div>
</header>

<form method="post" id="create-instance-form" class="surface">
    <div class="form-section">
        <label for="hostnames">Hostnames (comma-separated)</label>
        <input type="text" id="hostnames" name="hostnames" value="{{ form_data.get('hostnames', '') }}" required>
        <p class="help-text">You can submit up to 10 hostnames. Each hostname provisions a separate instance.</p>
    </div>

    <div class="fields-grid">
        <div class="form-section">
            <label for="region">Region</label>
            <select id="region" name="region" required>
                {% for region in regions %}
                <option value="{{ region.id }}" {% if selected_region == region.id %}selected{% endif %}>{{ region.name }}</option>
                {% endfor %}
            </select>
            <p class="help-text">Switch regions to load available plans and thresholds.</p>
        </div>
        <div class="form-section">
            <label for="instance_class">Instance class</label>
            <select id="instance_class" name="instance_class">
                <option value="default" {% if form_data.get('instance_class', 'default') == 'default' %}selected{% endif %}>Default</option>
                <option value="cpu-optimized" {% if form_data.get('instance_class') == 'cpu-optimized' %}selected{% endif %}>CPU Optimized</option>
                <option value="gpu-provided" {% if form_data.get('instance_class') == 'gpu-provided' %}selected{% endif %}>GPU Provided</option>
            </select>
            <p class="help-text">Use custom class types for specialised workloads.</p>
        </div>
    </div>

    <div class="form-section">
        <span class="form-label">Plan type</span>
        <div class="radio-group">
            <label>
                <input type="radio" name="plan_type" value="fixed" {% if plan_type != 'custom' %}checked{% endif %}>
                Use existing product
            </label>
            <label>
                <input type="radio" name="plan_type" value="custom" {% if plan_type == 'custom' %}checked{% endif %}>
                Custom resources
            </label>
        </div>
    </div>

    <div id="fixed-plan-fields" class="form-section {% if plan_type == 'custom' %}hidden{% endif %}">
        <input type="hidden" id="product_id" name="product_id" value="{{ selected_product_id }}">
        <span class="form-label">Product catalog</span>
        <p class="help-text">Products include predefined CPU, RAM, and disk. You can optionally extend disk or bandwidth.</p>
        <div data-product-grid role="list">
            {% if products %}
            {% for product in products %}
            {% set spec = product.plan.specification if product.plan and product.plan.specification else {} %}
            {% set price = product.priceItems[0] if product.priceItems else None %}
            <article role="listitem" data-product-id="{{ product.id }}" tabindex="0"{% if selected_product_id == product.id %} data-selected="true"{% endif %}>
                <header>
                    <h3>{{ product.plan.name | default('Product ' ~ product.id) }}</h3>
                    <p>
                        {{ spec.cpu | default('?') }} vCPU ·
                        {{ spec.ram | default('?') }} RAM ·
                        {{ spec.disk | default('?') }} Disk
                    </p>
                </header>
                {% if product.plan and product.plan.description %}
                <p>{{ product.plan.description }}</p>
                {% endif %}
                <dl>
                    <div>
                        <dt>Identifier</dt>
                        <dd>{{ product.id }}</dd>
                    </div>
                    {% if price and price.hourlyPrice is not none %}
                    <div>
                        <dt>Hourly</dt>
                        <dd>${{ price.hourlyPrice }}</dd>
                    </div>
                    {% endif %}
                    {% if price and price.monthlyPrice is not none %}
                    <div>
                        <dt>Monthly</dt>
                        <dd>${{ price.monthlyPrice }}</dd>
                    </div>
                    {% endif %}
                </dl>
                {% if product.tags %}
                <footer>
                    <p>
                        {% if product.tags is string %}
                        {{ product.tags }}
                        {% else %}
                        {{ product.tags | join(', ') }}
                        {% endif %}
                    </p>
                </footer>
                {% endif %}
            </article>
            {% endfor %}
            {% else %}
            <p>No products available for this region.</p>
            {% endif %}
        </div>
        <div id="product-details" class="product-details muted"></div>
        <div class="fields-grid compact">
            <div>
                <label for="fixed_diskInGB">Extra Disk (GB)</label>
                <input type="number" id="fixed_diskInGB" name="fixed_diskInGB" min="1" value="{{ form_data.get('fixed_diskInGB', '') }}">
            </div>
            <div>
                <label for="fixed_bandwidthInTB">Extra Bandwidth (TB)</label>
                <input type="number" id="fixed_bandwidthInTB" name="fixed_bandwidthInTB" min="1" value="{{ form_data.get('fixed_bandwidthInTB', '') }}">
            </div>
        </div>
    </div>

    <div id="custom-plan-fields" class="form-section {% if plan_type != 'custom' %}hidden{% endif %}">
        <p class="help-text" id="threshold-message">Provide the desired resource values for the custom plan.</p>
        <div class="fields-grid compact">
            <div>
                <label for="cpu">CPU (cores)</label>
                <input type="number" id="cpu" name="cpu" min="1" value="{{ form_data.get('cpu', '') }}">
            </div>
            <div>
                <label for="ramInGB">RAM (GB)</label>
                <input type="number" id="ramInGB" name="ramInGB" min="1" value="{{ form_data.get('ramInGB', '') }}">
            </div>
            <div>
                <label for="diskInGB">Disk (GB)</label>
                <input type="number" id="diskInGB" name="diskInGB" min="1" value="{{ form_data.get('diskInGB', '') }}">
            </div>
            <div>
                <label for="bandwidthInTB">Bandwidth (TB)</label>
                <input type="number" id="bandwidthInTB" name="bandwidthInTB" min="1" value="{{ form_data.get('bandwidthInTB', '') }}">
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="fields-grid compact">
            <div>
                <label for="floating_ip_count">Floating IP count</label>
                <input type="number" id="floating_ip_count" name="floating_ip_count" min="0" max="5" value="{{ form_data.get('floating_ip_count', '') }}">
                <p class="help-text">Optional. Allocate up to five floating IPs during provisioning.</p>
            </div>
            <div>
                <label for="ssh_key_ids">SSH Key IDs</label>
                <input type="text" id="ssh_key_ids" name="ssh_key_ids" placeholder="e.g. 123, 456" value="{{ form_data.get('ssh_key_ids', '') }}">
                <p class="help-text">Optional. Comma-separated list of SSH key IDs already uploaded in the panel.</p>
            </div>
        </div>
        <div class="checkbox-group">
            <label>
                <input type="checkbox" id="assign_ipv4" name="assign_ipv4" {% if form_data.get('assign_ipv4', 'on') %}checked{% endif %}>
                Assign IPv4
            </label>
            <label>
                <input type="checkbox" id="assign_ipv6" name="assign_ipv6" {% if form_data.get('assign_ipv6') %}checked{% endif %}>
                Assign IPv6
            </label>
        </div>
    </div>

    <button type="submit">Create Instance</button>
</form>

<script>
(() => {
    const planTypeRadios = document.querySelectorAll('input[name="plan_type"]');
    const fixedFields = document.getElementById('fixed-plan-fields');
    const customFields = document.getElementById('custom-plan-fields');
    const regionSelect = document.getElementById('region');
    const productField = document.getElementById('product_id');
    const productList = document.querySelector('[data-product-grid]');
    const productDetails = document.getElementById('product-details');
    const thresholdMessage = document.getElementById('threshold-message');
    const regionConfigs = {{ region_configs | tojson }};
    const initialProducts = {{ products | tojson }};
    const preselectedProduct = "{{ selected_product_id or '' }}";
    let currentProducts = [];
    let lastFixedProductSelection = preselectedProduct;

    if (!regionSelect || !productField || !productList) {
        return;
    }

    const customInputs = customFields ? customFields.querySelectorAll('input') : [];
    const fixedExtraInputs = fixedFields ? fixedFields.querySelectorAll('input') : [];
    const ramInput = document.getElementById('ramInGB');
    const diskInput = document.getElementById('diskInGB');

    function getPlanType() {
        return document.querySelector('input[name="plan_type"]:checked')?.value || 'fixed';
    }

    function setCustomInputsDisabled(disabled) {
        customInputs.forEach(input => {
            input.disabled = disabled;
        });
    }

    function setFixedExtrasDisabled(disabled) {
        fixedExtraInputs.forEach(input => {
            input.disabled = disabled;
        });
    }

    function renderProductDetails(productId) {
        if (!productDetails) {
            return;
        }
        if (getPlanType() === 'custom') {
            productDetails.textContent = 'Custom plan selected. Product catalog is disabled.';
            return;
        }
        const product = currentProducts.find(item => String(item.id) === String(productId));
        if (!product) {
            productDetails.textContent = currentProducts.length
                ? 'Select a product to review its specs.'
                : 'No products available for the selected region.';
            return;
        }
        const spec = product.plan?.specification || {};
        const priceInfo = product.priceItems?.[0];
        const chunks = [];
        if (spec.cpu) chunks.push(`${spec.cpu} vCPU`);
        if (spec.ram) chunks.push(`${spec.ram} RAM`);
        if (spec.disk) chunks.push(`${spec.disk} Disk`);
        if (spec.bandwidth) chunks.push(`${spec.bandwidth} Bandwidth`);
        if (priceInfo) {
            const pieces = [];
            if (priceInfo.hourlyPrice !== undefined && priceInfo.hourlyPrice !== null) {
                pieces.push(`$${Number(priceInfo.hourlyPrice).toFixed(2)}/hr`);
            }
            if (priceInfo.monthlyPrice !== undefined && priceInfo.monthlyPrice !== null) {
                pieces.push(`$${Number(priceInfo.monthlyPrice).toFixed(2)}/mo`);
            }
            if (pieces.length) chunks.push(`Pricing: ${pieces.join(' · ')}`);
        }
        productDetails.textContent = chunks.join(' · ');
    }

    function markProductSelection(productId) {
        const normalized = productId ? String(productId) : '';
        productField.value = normalized;
        productList.querySelectorAll('[data-product-id]').forEach(card => {
            if (normalized && String(card.dataset.productId) === normalized) {
                card.setAttribute('data-selected', 'true');
                card.setAttribute('aria-pressed', 'true');
            } else {
                card.removeAttribute('data-selected');
                card.setAttribute('aria-pressed', 'false');
            }
        });
        if (getPlanType() === 'fixed' && normalized) {
            lastFixedProductSelection = normalized;
        }
        renderProductDetails(normalized);
    }

    function setProductCardsDisabled(disabled) {
        if (disabled) {
            productList.setAttribute('data-disabled', 'true');
        } else {
            productList.removeAttribute('data-disabled');
        }
        productList.querySelectorAll('[data-product-id]').forEach(card => {
            card.setAttribute('aria-disabled', disabled ? 'true' : 'false');
            card.tabIndex = disabled ? -1 : 0;
        });
        if (disabled) {
            renderProductDetails('');
        } else if (productField.value) {
            renderProductDetails(productField.value);
        }
    }

    function buildDefinition(term, value) {
        const container = document.createElement('div');
        const dt = document.createElement('dt');
        dt.textContent = term;
        const dd = document.createElement('dd');
        dd.textContent = value;
        container.appendChild(dt);
        container.appendChild(dd);
        return container;
    }

    function buildProductCard(product) {
        const spec = product.plan?.specification || {};
        const priceInfo = product.priceItems?.[0];
        const card = document.createElement('article');
        card.setAttribute('role', 'listitem');
        card.dataset.productId = product.id;
        card.tabIndex = 0;
        card.setAttribute('aria-pressed', 'false');

        const header = document.createElement('header');
        const title = document.createElement('h3');
        title.textContent = product.plan?.name || `Product ${product.id}`;
        header.appendChild(title);

        const summary = document.createElement('p');
        const summaryParts = [
            spec.cpu ? `${spec.cpu} vCPU` : '? vCPU',
            spec.ram ? `${spec.ram} RAM` : '? RAM',
            spec.disk ? `${spec.disk} Disk` : '? Disk'
        ];
        summary.textContent = summaryParts.join(' · ');
        header.appendChild(summary);
        card.appendChild(header);

        if (product.plan?.description) {
            const description = document.createElement('p');
            description.textContent = product.plan.description;
            card.appendChild(description);
        }

        const meta = document.createElement('dl');
        meta.appendChild(buildDefinition('Identifier', String(product.id)));
        if (priceInfo && priceInfo.hourlyPrice !== undefined && priceInfo.hourlyPrice !== null) {
            meta.appendChild(buildDefinition('Hourly', `$${Number(priceInfo.hourlyPrice).toFixed(2)}`));
        }
        if (priceInfo && priceInfo.monthlyPrice !== undefined && priceInfo.monthlyPrice !== null) {
            meta.appendChild(buildDefinition('Monthly', `$${Number(priceInfo.monthlyPrice).toFixed(2)}`));
        }
        card.appendChild(meta);

        const tagsValue = Array.isArray(product.tags)
            ? product.tags.join(', ')
            : (product.tags || '');
        if (tagsValue) {
            const footer = document.createElement('footer');
            const tagsText = document.createElement('p');
            tagsText.textContent = tagsValue;
            footer.appendChild(tagsText);
            card.appendChild(footer);
        }

        return card;
    }

    function populateProducts(products, selected) {
        currentProducts = products || [];
        productList.innerHTML = '';
        const isFixedPlan = getPlanType() === 'fixed';
        const normalizedSelection = isFixedPlan
            ? (selected || lastFixedProductSelection || '')
            : '';

        if (!currentProducts.length) {
            const emptyMessage = document.createElement('p');
            emptyMessage.textContent = 'No products available for this region.';
            productList.appendChild(emptyMessage);
            markProductSelection('');
            return;
        }

        currentProducts.forEach(product => {
            const card = buildProductCard(product);
            if (normalizedSelection && String(product.id) === String(normalizedSelection)) {
                card.setAttribute('data-selected', 'true');
                card.setAttribute('aria-pressed', 'true');
            }
            productList.appendChild(card);
        });

        const selectionExists = normalizedSelection
            && currentProducts.some(item => String(item.id) === String(normalizedSelection));

        if (selectionExists) {
            markProductSelection(normalizedSelection);
        } else {
            if (normalizedSelection) {
                lastFixedProductSelection = '';
            }
            markProductSelection('');
        }
        setProductCardsDisabled(getPlanType() === 'custom');
    }

    function updateThresholdMessage(regionId) {
        const config = regionConfigs?.[regionId] || {};
        const requirements = [];
        if (config.ramThresholdInGB) {
            requirements.push(`RAM ≥ ${config.ramThresholdInGB} GB`);
        }
        if (config.diskThresholdInGB) {
            requirements.push(`Disk ≥ ${config.diskThresholdInGB} GB`);
        }
        if (getPlanType() !== 'custom') {
            thresholdMessage.textContent = 'Switch to custom resources to enter manual values.';
            return;
        }
        thresholdMessage.textContent = requirements.length
            ? `Custom plans in this region must meet: ${requirements.join(' · ')}.`
            : 'Provide the desired resource values for the custom plan.';
    }

    function updateThresholdConstraints(regionId) {
        const config = regionConfigs?.[regionId] || {};
        const isCustom = getPlanType() === 'custom';
        const minRam = config.ramThresholdInGB || 1;
        const minDisk = config.diskThresholdInGB || 1;
        if (ramInput) {
            if (isCustom) {
                ramInput.min = minRam;
            } else {
                ramInput.removeAttribute('min');
            }
        }
        if (diskInput) {
            if (isCustom) {
                diskInput.min = minDisk;
            } else {
                diskInput.removeAttribute('min');
            }
        }
    }

    function applyPlanType() {
        const isCustom = getPlanType() === 'custom';
        if (fixedFields) {
            fixedFields.classList.toggle('hidden', isCustom);
        }
        if (customFields) {
            customFields.classList.toggle('hidden', !isCustom);
        }

        setCustomInputsDisabled(!isCustom);
        setFixedExtrasDisabled(isCustom);

        if (isCustom) {
            if (productField.value) {
                lastFixedProductSelection = productField.value;
            }
            markProductSelection('');
        } else if (lastFixedProductSelection) {
            markProductSelection(lastFixedProductSelection);
        } else {
            renderProductDetails('');
        }

        setProductCardsDisabled(isCustom);
        updateThresholdMessage(regionSelect.value);
        updateThresholdConstraints(regionSelect.value);
    }

    async function fetchProducts(regionId, preserveSelection = false) {
        if (!regionId) {
            populateProducts([], null);
            return;
        }

        const keepSelection = preserveSelection && getPlanType() === 'fixed'
            ? (productField.value || lastFixedProductSelection || '')
            : '';

        productList.innerHTML = '';
        const loading = document.createElement('p');
        loading.textContent = 'Loading products…';
        productList.appendChild(loading);

        try {
            const response = await fetch(`/api/regions/${regionId}/products`);
            if (!response.ok) {
                throw new Error('Unable to load products for the selected region.');
            }
            const payload = await response.json();
            populateProducts(payload.products || [], keepSelection);
        } catch (error) {
            productList.innerHTML = '';
            const message = document.createElement('p');
            message.textContent = error.message;
            productList.appendChild(message);
            currentProducts = [];
            markProductSelection('');
        } finally {
            setProductCardsDisabled(getPlanType() === 'custom');
        }
    }

    function handleProductSelection(target) {
        if (!target || getPlanType() === 'custom' || target.getAttribute('aria-disabled') === 'true') {
            return;
        }
        const productId = target.dataset.productId || '';
        markProductSelection(productId);
    }

    planTypeRadios.forEach(radio => radio.addEventListener('change', () => {
        applyPlanType();
    }));

    productList.addEventListener('click', event => {
        const card = event.target.closest('[data-product-id]');
        if (card) {
            handleProductSelection(card);
        }
    });

    productList.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
            const card = event.target.closest('[data-product-id]');
            if (card) {
                event.preventDefault();
                handleProductSelection(card);
            }
        }
    });

    regionSelect.addEventListener('change', () => {
        const regionId = regionSelect.value;
        updateThresholdMessage(regionId);
        updateThresholdConstraints(regionId);
        fetchProducts(regionId, true);
    });

    populateProducts(initialProducts, preselectedProduct);
    applyPlanType();
})();
</script>
{% endblock %}