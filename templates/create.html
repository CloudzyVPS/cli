{% extends "base.html" %}

{% block title %}Create Instance{% endblock %}

{% block content %}
<header class="page-header">
    <div>
        <h1>Provision New Instance</h1>
        <p>Select a predefined product or craft a custom configuration.</p>
    </div>
</header>

<form method="post" id="create-instance-form" class="surface">
    <div class="form-section">
        <label for="hostnames">Hostnames (comma-separated)</label>
        <input type="text" id="hostnames" name="hostnames" value="{{ form_data.get('hostnames', '') }}" required>
        <p class="help-text">You can submit up to 10 hostnames. Each hostname provisions a separate instance.</p>
    </div>

    <div class="fields-grid">
        <div class="form-section">
            <label for="region">Region</label>
            <select id="region" name="region" required>
                {% for region in regions %}
                <option value="{{ region.id }}" {% if selected_region == region.id %}selected{% endif %}>{{ region.name }}</option>
                {% endfor %}
            </select>
            <p class="help-text">Switch regions to load available plans and thresholds.</p>
        </div>
        <div class="form-section">
            <label for="instance_class">Instance class</label>
            <select id="instance_class" name="instance_class">
                <option value="default" {% if form_data.get('instance_class', 'default') == 'default' %}selected{% endif %}>Default</option>
                <option value="cpu-optimized" {% if form_data.get('instance_class') == 'cpu-optimized' %}selected{% endif %}>CPU Optimized</option>
                <option value="gpu-provided" {% if form_data.get('instance_class') == 'gpu-provided' %}selected{% endif %}>GPU Provided</option>
            </select>
            <p class="help-text">Use custom class types for specialised workloads.</p>
        </div>
    </div>

    <div class="form-section">
        <span class="form-label">Plan type</span>
        <div class="radio-group">
            <label>
                <input type="radio" name="plan_type" value="fixed" {% if plan_type != 'custom' %}checked{% endif %}>
                <span>Use existing product</span>
            </label>
            <label>
                <input type="radio" name="plan_type" value="custom" {% if plan_type == 'custom' %}checked{% endif %}>
                <span>Custom resources</span>
            </label>
        </div>
    </div>

    <div id="fixed-plan-fields" class="form-section {% if plan_type == 'custom' %}hidden{% endif %}">
        <input type="hidden" id="product_id" name="product_id" value="{{ selected_product_id }}">
        <span class="form-label">Product catalog</span>
        <p class="help-text">Products include predefined CPU, RAM, and disk. You can optionally extend disk or bandwidth.</p>
        <div data-product-grid role="list">
            {% if products %}
            {% for product in products %}
            {% set spec = product.plan.specification if product.plan and product.plan.specification else {} %}
            {% set price = product.priceItems[0] if product.priceItems else None %}
            {% set region_meta = region_lookup.get(product.get('regionId')) if product.get('regionId') else None %}
            {% set spec_lines = [] %}
            {% if spec.cpu is not none %}
            {% if spec.cpu is number %}
            {% set spec_lines = spec_lines + [{'term': 'CPU', 'value': spec.cpu ~ ' vCPU'}] %}
            {% else %}
            {% set spec_lines = spec_lines + [{'term': 'CPU', 'value': spec.cpu}] %}
            {% endif %}
            {% endif %}
            {% if spec.ram is not none %}
            {% if spec.ram is number %}
            {% set spec_lines = spec_lines + [{'term': 'RAM', 'value': spec.ram ~ ' GB'}] %}
            {% else %}
            {% set spec_lines = spec_lines + [{'term': 'RAM', 'value': spec.ram}] %}
            {% endif %}
            {% endif %}
            {% if spec.disk is not none %}
            {% if spec.disk is number %}
            {% set spec_lines = spec_lines + [{'term': 'Disk', 'value': spec.disk ~ ' GB'}] %}
            {% else %}
            {% set spec_lines = spec_lines + [{'term': 'Disk', 'value': spec.disk}] %}
            {% endif %}
            {% endif %}
            {% if spec.bandwidth is not none %}
            {% if spec.bandwidth is number %}
            {% set spec_lines = spec_lines + [{'term': 'Bandwidth', 'value': spec.bandwidth ~ ' TB'}] %}
            {% else %}
            {% set spec_lines = spec_lines + [{'term': 'Bandwidth', 'value': spec.bandwidth}] %}
            {% endif %}
            {% endif %}
            {% set summary = [] %}
            {% for entry in spec_lines %}
            {% if loop.index0 < 3 %}
            {% set summary = summary + [entry.value] %}
            {% endif %}
            {% endfor %}
            {% set price_lines = [] %}
            {% if price and price.hourlyPrice is not none %}
            {% set price_lines = price_lines + [{'term': 'Hourly', 'value': '$' ~ ('%.2f' % (price.hourlyPrice | float)) ~ ' / hr'}] %}
            {% endif %}
            {% if price and price.monthlyPrice is not none %}
            {% set price_lines = price_lines + [{'term': 'Monthly', 'value': '$' ~ ('%.2f' % (price.monthlyPrice | float)) ~ ' / mo'}] %}
            {% endif %}
            <article role="listitem" data-product-id="{{ product.id }}" tabindex="0"{% if selected_product_id == product.id %} data-selected="true"{% endif %}>
                <header>
                    {% if region_meta and region_meta.name %}
                    <p data-product-region>{{ region_meta.name }}</p>
                    {% endif %}
                    <h3>
                        {{ product.plan.name | default('Product ' ~ product.id) }}
                    </h3>
                    {% if summary %}
                    <p data-product-summary>{{ summary | join(' · ') }}</p>
                    {% endif %}
                    <p data-product-code>Product ID {{ product.id }}</p>
                </header>
                {% if product.plan and product.plan.description %}
                <p data-product-note>{{ product.plan.description }}</p>
                {% endif %}
                {% if spec_lines %}
                <dl data-product-facts>
                    {% for entry in spec_lines %}
                    <div>
                        <dt>{{ entry.term }}</dt>
                        <dd>{{ entry.value }}</dd>
                    </div>
                    {% endfor %}
                </dl>
                {% endif %}
                {% if price_lines %}
                <dl data-product-pricing>
                    {% for entry in price_lines %}
                    <div>
                        <dt>{{ entry.term }}</dt>
                        <dd>{{ entry.value }}</dd>
                    </div>
                    {% endfor %}
                </dl>
                {% endif %}
                {% if product.tags %}
                <footer>
                    <p data-product-tags>
                        {% if product.tags is string %}
                        {{ product.tags }}
                        {% else %}
                        {{ product.tags | join(', ') }}
                        {% endif %}
                    </p>
                </footer>
                {% endif %}
            </article>
            {% endfor %}
            {% else %}
            <p>No products available for this region.</p>
            {% endif %}
        </div>
        <div id="product-details" class="product-details"></div>
        <div class="fields-grid compact">
            <div>
                <label for="fixed_diskInGB">Extra Disk (GB)</label>
                <input type="number" id="fixed_diskInGB" name="fixed_diskInGB" min="1" value="{{ form_data.get('fixed_diskInGB', '') }}">
            </div>
            <div>
                <label for="fixed_bandwidthInTB">Extra Bandwidth (TB)</label>
                <input type="number" id="fixed_bandwidthInTB" name="fixed_bandwidthInTB" min="1" value="{{ form_data.get('fixed_bandwidthInTB', '') }}">
            </div>
        </div>
    </div>

    <div id="custom-plan-fields" class="form-section {% if plan_type != 'custom' %}hidden{% endif %}">
        <p class="help-text" id="threshold-message">Provide the desired resource values for the custom plan.</p>
        <div class="fields-grid compact">
            <div>
                <label for="cpu">CPU (cores)</label>
                <input type="number" id="cpu" name="cpu" min="1" value="{{ form_data.get('cpu', '') }}">
            </div>
            <div>
                <label for="ramInGB">RAM (GB)</label>
                <input type="number" id="ramInGB" name="ramInGB" min="1" value="{{ form_data.get('ramInGB', '') }}">
            </div>
            <div>
                <label for="diskInGB">Disk (GB)</label>
                <input type="number" id="diskInGB" name="diskInGB" min="1" value="{{ form_data.get('diskInGB', '') }}">
            </div>
            <div>
                <label for="bandwidthInTB">Bandwidth (TB)</label>
                <input type="number" id="bandwidthInTB" name="bandwidthInTB" min="1" value="{{ form_data.get('bandwidthInTB', '') }}">
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="fields-grid compact">
            <div>
                <label for="floating_ip_count">Floating IP count</label>
                <input type="number" id="floating_ip_count" name="floating_ip_count" min="0" max="5" value="{{ form_data.get('floating_ip_count', '') }}">
                <p class="help-text">Optional. Allocate up to five floating IPs during provisioning.</p>
            </div>
            <div>
                <label for="ssh_key_ids">SSH Key IDs</label>
                <input type="text" id="ssh_key_ids" name="ssh_key_ids" placeholder="e.g. 123, 456" value="{{ form_data.get('ssh_key_ids', '') }}">
                <p class="help-text">Optional. Comma-separated list of SSH key IDs already uploaded in the panel.</p>
            </div>
        </div>
        <div class="checkbox-group">
            <label>
                <input type="checkbox" id="assign_ipv4" name="assign_ipv4" {% if form_data.get('assign_ipv4', 'on') %}checked{% endif %}>
                <span>Assign IPv4</span>
            </label>
            <label>
                <input type="checkbox" id="assign_ipv6" name="assign_ipv6" {% if form_data.get('assign_ipv6') %}checked{% endif %}>
                <span>Assign IPv6</span>
            </label>
        </div>
    </div>

    <button type="submit">Create Instance</button>
</form>

<script>
(() => {
    const planTypeRadios = document.querySelectorAll('input[name="plan_type"]');
    const fixedFields = document.getElementById('fixed-plan-fields');
    const customFields = document.getElementById('custom-plan-fields');
    const regionSelect = document.getElementById('region');
    const productField = document.getElementById('product_id');
    const productList = document.querySelector('[data-product-grid]');
    const productDetails = document.getElementById('product-details');
    const thresholdMessage = document.getElementById('threshold-message');
    const regionConfigs = {{ region_configs | tojson }};
    const regionLookup = {{ region_lookup | tojson }};
    const initialProducts = {{ products | tojson }};
    const preselectedProduct = "{{ selected_product_id or '' }}";
    let currentProducts = [];
    let lastFixedProductSelection = preselectedProduct;

    if (!regionSelect || !productField || !productList) {
        return;
    }

    const customInputs = customFields ? customFields.querySelectorAll('input') : [];
    const fixedExtraInputs = fixedFields ? fixedFields.querySelectorAll('input') : [];
    const ramInput = document.getElementById('ramInGB');
    const diskInput = document.getElementById('diskInGB');

    function getPlanType() {
        return document.querySelector('input[name="plan_type"]:checked')?.value || 'fixed';
    }

    function setCustomInputsDisabled(disabled) {
        customInputs.forEach(input => {
            input.disabled = disabled;
        });
    }

    function setFixedExtrasDisabled(disabled) {
        fixedExtraInputs.forEach(input => {
            input.disabled = disabled;
        });
    }

    function clearElement(target) {
        if (!target) {
            return;
        }
        while (target.firstChild) {
            target.removeChild(target.firstChild);
        }
    }

    function getRegionMeta(product) {
        const regionId = product?.regionId || product?.region?.id;
        if (!regionId) {
            return null;
        }
        return regionLookup?.[regionId] || null;
    }

    function formatSpecValue(key, value) {
        if (value === null || value === undefined) {
            return '';
        }
        const numericValue = Number(value);
        const isNumeric = Number.isFinite(numericValue);
        const trimmed = typeof value === 'string' ? value.trim() : '';
        if (!isNumeric && !trimmed) {
            return '';
        }
        const unitMap = {
            cpu: 'vCPU',
            ram: 'GB',
            disk: 'GB',
            bandwidth: 'TB',
        };
        if (isNumeric && unitMap[key]) {
            return `${numericValue} ${unitMap[key]}`;
        }
        if (!isNumeric && unitMap[key] && /^\d+(\.\d+)?$/.test(trimmed)) {
            return `${trimmed} ${unitMap[key]}`;
        }
        return (typeof value === 'string' ? value.trim() : `${value}`) || '';
    }

    function buildSpecEntries(product) {
        const spec = product?.plan?.specification || {};
        const keys = [
            ['cpu', 'CPU'],
            ['ram', 'RAM'],
            ['disk', 'Disk'],
            ['bandwidth', 'Bandwidth'],
        ];
        return keys
            .map(([key, label]) => {
                const formatted = formatSpecValue(key, spec?.[key]);
                return formatted ? { term: label, value: formatted } : null;
            })
            .filter(Boolean);
    }

    function formatPrice(value, cadence) {
        const numeric = Number(value);
        if (Number.isFinite(numeric)) {
            const rounded = numeric.toFixed(2);
            return cadence ? `$${rounded} / ${cadence}` : `$${rounded}`;
        }
        return value !== null && value !== undefined ? String(value) : '';
    }

    function buildPriceEntries(product) {
        const priceInfo = product?.priceItems?.[0];
        if (!priceInfo) {
            return [];
        }
        const entries = [];
        if (priceInfo.hourlyPrice !== undefined && priceInfo.hourlyPrice !== null) {
            entries.push({ term: 'Hourly', value: formatPrice(priceInfo.hourlyPrice, 'hr') });
        }
        if (priceInfo.monthlyPrice !== undefined && priceInfo.monthlyPrice !== null) {
            entries.push({ term: 'Monthly', value: formatPrice(priceInfo.monthlyPrice, 'mo') });
        }
        return entries;
    }

    function buildSpecSummary(specEntries) {
        if (!specEntries || !specEntries.length) {
            return '';
        }
        return specEntries.slice(0, 3).map(entry => entry.value).join(' · ');
    }

    function createDefinitionList(entries, dataAttribute) {
        if (!entries.length) {
            return null;
        }
        const dl = document.createElement('dl');
        if (dataAttribute) {
            dl.setAttribute(dataAttribute, 'true');
        }
        entries.forEach(entry => {
            const wrapper = document.createElement('div');
            const term = document.createElement('dt');
            term.textContent = entry.term;
            const detail = document.createElement('dd');
            detail.textContent = entry.value;
            wrapper.appendChild(term);
            wrapper.appendChild(detail);
            dl.appendChild(wrapper);
        });
        return dl;
    }

    function formatTags(tags) {
        if (!tags) {
            return '';
        }
        if (Array.isArray(tags)) {
            return tags.join(', ');
        }
        return String(tags);
    }

    function composeProductHeadline(product) {
        const planName = product?.plan?.name || `Product ${product?.id}`;
        const regionName = getRegionMeta(product)?.name;
        return regionName ? `${regionName} • ${planName}` : planName;
    }

    function renderProductDetails(productId) {
        if (!productDetails) {
            return;
        }
        clearElement(productDetails);
        if (getPlanType() === 'custom') {
            const note = document.createElement('p');
            note.classList.add('muted');
            note.textContent = 'Custom plan selected. Product catalog is disabled.';
            productDetails.appendChild(note);
            return;
        }
        const product = currentProducts.find(item => String(item.id) === String(productId));
        if (!product) {
            const message = document.createElement('p');
            message.classList.add('muted');
            message.textContent = currentProducts.length
                ? 'Select a product to review its specs.'
                : 'No products available for the selected region.';
            productDetails.appendChild(message);
            return;
        }

        const invoice = document.createElement('section');
        invoice.setAttribute('data-product-invoice', 'true');

        const header = document.createElement('header');
        header.setAttribute('data-product-invoice-header', 'true');

        const regionMeta = getRegionMeta(product);
        if (regionMeta?.name) {
            const region = document.createElement('p');
            region.setAttribute('data-product-region', 'true');
            region.textContent = regionMeta.name;
            header.appendChild(region);
        }

        const title = document.createElement('h3');
        title.textContent = composeProductHeadline(product);
        header.appendChild(title);

        const specEntries = buildSpecEntries(product);
        const summary = buildSpecSummary(specEntries);
        if (summary) {
            const summaryLine = document.createElement('p');
            summaryLine.setAttribute('data-product-summary', 'true');
            summaryLine.textContent = summary;
            header.appendChild(summaryLine);
        }

        const identifier = document.createElement('p');
        identifier.setAttribute('data-product-code', 'true');
        identifier.textContent = `Product ID ${product.id}`;
        header.appendChild(identifier);

        invoice.appendChild(header);

        const body = document.createElement('div');
        body.setAttribute('data-product-invoice-body', 'true');

        if (specEntries.length) {
            const resourcesSection = document.createElement('section');
            resourcesSection.setAttribute('data-product-invoice-section', 'resources');
            const sectionTitle = document.createElement('h4');
            sectionTitle.textContent = 'Resources';
            resourcesSection.appendChild(sectionTitle);
            const factsList = createDefinitionList(specEntries, 'data-product-facts');
            if (factsList) {
                resourcesSection.appendChild(factsList);
            }
            body.appendChild(resourcesSection);
        }

        const priceEntries = buildPriceEntries(product);
        if (priceEntries.length) {
            const pricingSection = document.createElement('section');
            pricingSection.setAttribute('data-product-invoice-section', 'pricing');
            const sectionTitle = document.createElement('h4');
            sectionTitle.textContent = 'Pricing';
            pricingSection.appendChild(sectionTitle);
            const priceList = createDefinitionList(priceEntries, 'data-product-pricing');
            if (priceList) {
                pricingSection.appendChild(priceList);
            }
            body.appendChild(pricingSection);
        }

        if (body.children.length) {
            invoice.appendChild(body);
        }

        const description = product?.plan?.description;
        if (description) {
            const note = document.createElement('p');
            note.setAttribute('data-product-note', 'true');
            note.textContent = description;
            invoice.appendChild(note);
        }

        const tagsValue = formatTags(product?.tags);
        if (tagsValue) {
            const footer = document.createElement('footer');
            footer.setAttribute('data-product-invoice-footer', 'true');
            const tagsText = document.createElement('p');
            tagsText.setAttribute('data-product-tags', 'true');
            tagsText.textContent = tagsValue;
            footer.appendChild(tagsText);
            invoice.appendChild(footer);
        }

        productDetails.appendChild(invoice);
    }

    function markProductSelection(productId) {
        const normalized = productId ? String(productId) : '';
        productField.value = normalized;
        productList.querySelectorAll('[data-product-id]').forEach(card => {
            if (normalized && String(card.dataset.productId) === normalized) {
                card.setAttribute('data-selected', 'true');
                card.setAttribute('aria-pressed', 'true');
            } else {
                card.removeAttribute('data-selected');
                card.setAttribute('aria-pressed', 'false');
            }
        });
        if (getPlanType() === 'fixed' && normalized) {
            lastFixedProductSelection = normalized;
        }
        renderProductDetails(normalized);
    }

    function setProductCardsDisabled(disabled) {
        if (disabled) {
            productList.setAttribute('data-disabled', 'true');
        } else {
            productList.removeAttribute('data-disabled');
        }
        productList.querySelectorAll('[data-product-id]').forEach(card => {
            card.setAttribute('aria-disabled', disabled ? 'true' : 'false');
            card.tabIndex = disabled ? -1 : 0;
        });
        if (disabled) {
            renderProductDetails('');
        } else if (productField.value) {
            renderProductDetails(productField.value);
        }
    }

    function buildProductCard(product) {
        const card = document.createElement('article');
        card.setAttribute('role', 'listitem');
        card.dataset.productId = product.id;
        card.tabIndex = 0;
        card.setAttribute('aria-pressed', 'false');

        const header = document.createElement('header');
        const regionMeta = getRegionMeta(product);
        if (regionMeta?.name) {
            const region = document.createElement('p');
            region.setAttribute('data-product-region', 'true');
            region.textContent = regionMeta.name;
            header.appendChild(region);
        }

        const title = document.createElement('h3');
        title.textContent = product?.plan?.name || `Product ${product.id}`;
        header.appendChild(title);

        const specEntries = buildSpecEntries(product);
        const summary = buildSpecSummary(specEntries);
        if (summary) {
            const summaryLine = document.createElement('p');
            summaryLine.setAttribute('data-product-summary', 'true');
            summaryLine.textContent = summary;
            header.appendChild(summaryLine);
        }

        const code = document.createElement('p');
        code.setAttribute('data-product-code', 'true');
        code.textContent = `Product ID ${product.id}`;
        header.appendChild(code);
        card.appendChild(header);

        if (product?.plan?.description) {
            const description = document.createElement('p');
            description.setAttribute('data-product-note', 'true');
            description.textContent = product.plan.description;
            card.appendChild(description);
        }

        if (specEntries.length) {
            const factsList = createDefinitionList(specEntries, 'data-product-facts');
            if (factsList) {
                card.appendChild(factsList);
            }
        }

        const priceEntries = buildPriceEntries(product);
        if (priceEntries.length) {
            const priceList = createDefinitionList(priceEntries, 'data-product-pricing');
            if (priceList) {
                card.appendChild(priceList);
            }
        }

        const tagsValue = formatTags(product?.tags);
        if (tagsValue) {
            const footer = document.createElement('footer');
            const tagsText = document.createElement('p');
            tagsText.setAttribute('data-product-tags', 'true');
            tagsText.textContent = tagsValue;
            footer.appendChild(tagsText);
            card.appendChild(footer);
        }

        return card;
    }

    function populateProducts(products, selected) {
        currentProducts = products || [];
        productList.innerHTML = '';
        const isFixedPlan = getPlanType() === 'fixed';
        const normalizedSelection = isFixedPlan
            ? (selected || lastFixedProductSelection || '')
            : '';

        if (!currentProducts.length) {
            const emptyMessage = document.createElement('p');
            emptyMessage.textContent = 'No products available for this region.';
            productList.appendChild(emptyMessage);
            markProductSelection('');
            return;
        }

        currentProducts.forEach(product => {
            const card = buildProductCard(product);
            if (normalizedSelection && String(product.id) === String(normalizedSelection)) {
                card.setAttribute('data-selected', 'true');
                card.setAttribute('aria-pressed', 'true');
            }
            productList.appendChild(card);
        });

        const selectionExists = normalizedSelection
            && currentProducts.some(item => String(item.id) === String(normalizedSelection));

        if (selectionExists) {
            markProductSelection(normalizedSelection);
        } else {
            if (normalizedSelection) {
                lastFixedProductSelection = '';
            }
            markProductSelection('');
        }
        setProductCardsDisabled(getPlanType() === 'custom');
    }

    function updateThresholdMessage(regionId) {
        const config = regionConfigs?.[regionId] || {};
        const requirements = [];
        if (config.ramThresholdInGB) {
            requirements.push(`RAM ≥ ${config.ramThresholdInGB} GB`);
        }
        if (config.diskThresholdInGB) {
            requirements.push(`Disk ≥ ${config.diskThresholdInGB} GB`);
        }
        if (getPlanType() !== 'custom') {
            thresholdMessage.textContent = 'Switch to custom resources to enter manual values.';
            return;
        }
        thresholdMessage.textContent = requirements.length
            ? `Custom plans in this region must meet: ${requirements.join(' · ')}.`
            : 'Provide the desired resource values for the custom plan.';
    }

    function updateThresholdConstraints(regionId) {
        const config = regionConfigs?.[regionId] || {};
        const isCustom = getPlanType() === 'custom';
        const minRam = config.ramThresholdInGB || 1;
        const minDisk = config.diskThresholdInGB || 1;
        if (ramInput) {
            if (isCustom) {
                ramInput.min = minRam;
            } else {
                ramInput.removeAttribute('min');
            }
        }
        if (diskInput) {
            if (isCustom) {
                diskInput.min = minDisk;
            } else {
                diskInput.removeAttribute('min');
            }
        }
    }

    function applyPlanType() {
        const isCustom = getPlanType() === 'custom';
        if (fixedFields) {
            fixedFields.classList.toggle('hidden', isCustom);
        }
        if (customFields) {
            customFields.classList.toggle('hidden', !isCustom);
        }

        setCustomInputsDisabled(!isCustom);
        setFixedExtrasDisabled(isCustom);

        if (isCustom) {
            if (productField.value) {
                lastFixedProductSelection = productField.value;
            }
            markProductSelection('');
        } else if (lastFixedProductSelection) {
            markProductSelection(lastFixedProductSelection);
        } else {
            renderProductDetails('');
        }

        setProductCardsDisabled(isCustom);
        updateThresholdMessage(regionSelect.value);
        updateThresholdConstraints(regionSelect.value);
    }

    async function fetchProducts(regionId, preserveSelection = false) {
        if (!regionId) {
            populateProducts([], null);
            return;
        }

        const keepSelection = preserveSelection && getPlanType() === 'fixed'
            ? (productField.value || lastFixedProductSelection || '')
            : '';

        productList.innerHTML = '';
        const loading = document.createElement('p');
        loading.textContent = 'Loading products…';
        productList.appendChild(loading);

        try {
            const response = await fetch(`/api/regions/${regionId}/products`);
            if (!response.ok) {
                throw new Error('Unable to load products for the selected region.');
            }
            const payload = await response.json();
            populateProducts(payload.products || [], keepSelection);
        } catch (error) {
            productList.innerHTML = '';
            const message = document.createElement('p');
            message.textContent = error.message;
            productList.appendChild(message);
            currentProducts = [];
            markProductSelection('');
        } finally {
            setProductCardsDisabled(getPlanType() === 'custom');
        }
    }

    function handleProductSelection(target) {
        if (!target || getPlanType() === 'custom' || target.getAttribute('aria-disabled') === 'true') {
            return;
        }
        const productId = target.dataset.productId || '';
        markProductSelection(productId);
    }

    planTypeRadios.forEach(radio => radio.addEventListener('change', () => {
        applyPlanType();
    }));

    productList.addEventListener('click', event => {
        const card = event.target.closest('[data-product-id]');
        if (card) {
            handleProductSelection(card);
        }
    });

    productList.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
            const card = event.target.closest('[data-product-id]');
            if (card) {
                event.preventDefault();
                handleProductSelection(card);
            }
        }
    });

    regionSelect.addEventListener('change', () => {
        const regionId = regionSelect.value;
        updateThresholdMessage(regionId);
        updateThresholdConstraints(regionId);
        fetchProducts(regionId, true);
    });

    populateProducts(initialProducts, preselectedProduct);
    applyPlanType();
})();
</script>
{% endblock %}