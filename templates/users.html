{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<header class="page-header">
    <h1>User Management</h1>
    <p class="text-muted">Owners can create additional owners or admins, reset passwords, and adjust roles.</p>
</header>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Existing Users</h2>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Assigned Instances</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for username, data in users.items() %}
                    <tr>
                        <td>{{ username }}</td>
                        <td>{{ data.role|title }}</td>
                        <td>
                            {% if data.role == 'admin' %}
                                {{ data.assigned_instances|length }}
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-grid">
                                <form method="post" action="{{ url_for('update_role', username=username) }}">
                                    <label class="form-label">Role</label>
                                    <div class="d-flex gap-sm">
                                        <select name="role" class="form-control form-select">
                                            <option value="owner" {% if data.role == 'owner' %}selected{% endif %}>Owner</option>
                                            <option value="admin" {% if data.role == 'admin' %}selected{% endif %}>Admin</option>
                                        </select>
                                        <button type="submit" class="btn btn-secondary btn-sm">Update</button>
                                    </div>
                                </form>
                                <form method="post" action="{{ url_for('reset_password', username=username) }}">
                                    <label class="form-label">Reset Password</label>
                                    <div class="d-flex gap-sm">
                                        <input type="password" name="new_password" class="form-control" placeholder="New password" required>
                                        <button type="submit" class="btn btn-warning btn-sm">Save</button>
                                    </div>
                                </form>
                                <form method="post" action="{{ url_for('delete_user', username=username) }}" onsubmit="return confirm('Delete {{ username }}?');">
                                    <label class="form-label">Remove</label>
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Add User</h2>
    </div>
    <div class="card-body">
        <form method="post" class="form-grid">
            <div class="form-group">
                <label class="form-label" for="username">Username</label>
                <input class="form-control" type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input class="form-control" type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="role">Role</label>
                <select class="form-control form-select" id="role" name="role" required>
                    <option value="owner">Owner</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
